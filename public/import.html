<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Import</title>
</head>
<body>
  <h2>Import leads CSV</h2>
  <input type="file" id="file" accept=".csv" />
  <button id="btn">Import</button>
  <pre id="out"></pre>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const out = document.getElementById("out");
    const log = (m) => out.textContent += m + "\n";

    document.getElementById("btn").onclick = async () => {
      const f = document.getElementById("file").files[0];
      if (!f) return alert("Choose CSV");

      log("Parsing...");
      const parsed = await new Promise((resolve, reject) => {
        Papa.parse(f, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false,
          complete: resolve,
          error: reject
        });
      });

      const rows = parsed.data;
      log("Rows: " + rows.length);

      const fname = (f.name || "").toLowerCase();
      let cat = "";
      if (fname.includes("stomat")) cat = "stomatology";
      else if (fname.includes("business")) cat = "business_center";
      else if (fname.includes("auto")) cat = "auto_service";

      const chunkSize = 200;
      let totalInserted = 0, totalUpdated = 0, totalSkipped = 0;

      for (let i = 0; i < rows.length; i += chunkSize) {
        const chunk = rows.slice(i, i + chunkSize);

        const resp = await fetch(`/api/import?category=${encodeURIComponent(cat)}&city=${encodeURIComponent("Астана")}`, {
          method: "POST",
          headers: {"content-type":"application/json"},
          body: JSON.stringify(chunk)
        });

        const data = await resp.json().catch(() => ({}));
        log(`Chunk ${i/chunkSize + 1}: status ${resp.status}`);
        log(JSON.stringify(data, null, 2));

        totalInserted += (data.inserted || 0);
        totalUpdated += (data.updated || 0);
        totalSkipped += (data.skipped || 0);
      }

      log(`DONE. inserted=${totalInserted} updated=${totalUpdated} skipped=${totalSkipped}`);
    };
  </script>
</body>
</html>