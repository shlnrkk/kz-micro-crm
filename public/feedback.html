<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Email Feedback - KZ Micro CRM</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="min-h-screen">
    <!-- Top bar -->
    <header class="sticky top-0 z-10 border-b bg-white/80 backdrop-blur">
      <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-xl bg-slate-900 text-white grid place-items-center font-semibold">FB</div>
          <div>
            <div class="font-semibold leading-5">Feedback Tracker</div>
            <div class="text-xs text-slate-500">Email replies & responses</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <a href="/public/import.html" class="rounded-lg border bg-white px-3 py-2 text-sm hover:bg-slate-50">
            Import CSV
          </a>
          <a href="/public/" class="rounded-lg border bg-white px-3 py-2 text-sm hover:bg-slate-50">
            Back to CRM
          </a>
          <button id="refreshBtn" class="rounded-lg bg-slate-900 px-3 py-2 text-sm text-white hover:bg-slate-800">
            Refresh
          </button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="mx-auto max-w-7xl px-4 py-6">
      <div class="rounded-2xl border bg-white p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
          <label class="block">
            <div class="text-xs text-slate-500 mb-1">Channel</div>
            <select id="channel" class="w-full rounded-xl border px-3 py-2 text-sm">
              <option value="email">Email</option>
              <option value="call">Call</option>
              <option value="instagram">Instagram</option>
              <option value="whatsapp">WhatsApp</option>
              <option value="other">Other</option>
            </select>
          </label>

          <label class="block">
            <div class="text-xs text-slate-500 mb-1">Direction</div>
            <select id="direction" class="w-full rounded-xl border px-3 py-2 text-sm">
              <option value="inbound">Inbound</option>
              <option value="outbound">Outbound</option>
            </select>
          </label>

          <label class="block">
            <div class="text-xs text-slate-500 mb-1">Result</div>
            <input id="result" class="w-full rounded-xl border px-3 py-2 text-sm" placeholder="reply / no_answer / interested" />
          </label>

          <label class="block">
            <div class="text-xs text-slate-500 mb-1">Limit</div>
            <input id="limit" class="w-full rounded-xl border px-3 py-2 text-sm" type="number" value="20" min="1" max="100" />
          </label>
        </div>

        <button id="applyBtn" class="rounded-xl border px-4 py-2 text-sm hover:bg-slate-50 mr-2">
          Apply filters
        </button>
        <button id="clearBtn" class="rounded-xl border px-4 py-2 text-sm hover:bg-slate-50">
          Clear filters
        </button>
      </div>

      <!-- Feedback list -->
      <div id="feedbackList" class="space-y-3">
        <div class="text-center py-8 text-slate-500">Loading feedback...</div>
      </div>

      <!-- Pagination -->
      <div id="pagination" class="mt-6 flex items-center justify-between">
        <button id="prevBtn" class="rounded-lg border bg-white px-4 py-2 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
          Previous
        </button>
        <div id="pagerText" class="text-sm text-slate-600">-</div>
        <button id="nextBtn" class="rounded-lg border bg-white px-4 py-2 text-sm hover:bg-slate-50 disabled:opacity-50" disabled>
          Next
        </button>
      </div>
    </main>
  </div>

  <script>
    // State
    let feedback = [];
    let offset = 0;
    const defaultLimit = 20;

    // DOM elements
    const feedbackListEl = document.getElementById("feedbackList");
    const channelEl = document.getElementById("channel");
    const directionEl = document.getElementById("direction");
    const resultEl = document.getElementById("result");
    const limitEl = document.getElementById("limit");
    const applyBtnEl = document.getElementById("applyBtn");
    const clearBtnEl = document.getElementById("clearBtn");
    const refreshBtnEl = document.getElementById("refreshBtn");
    const prevBtnEl = document.getElementById("prevBtn");
    const nextBtnEl = document.getElementById("nextBtn");
    const pagerTextEl = document.getElementById("pagerText");

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
      loadFeedback();
      setupEventListeners();
    });

    function setupEventListeners() {
      applyBtnEl.onclick = () => { offset = 0; loadFeedback(); };
      clearBtnEl.onclick = () => {
        channelEl.value = "email";
        directionEl.value = "inbound";
        resultEl.value = "";
        limitEl.value = defaultLimit;
        offset = 0;
        loadFeedback();
      };
      refreshBtnEl.onclick = () => loadFeedback();
      prevBtnEl.onclick = () => { offset = Math.max(0, offset - getLimit()); loadFeedback(); };
      nextBtnEl.onclick = () => { offset += getLimit(); loadFeedback(); };
    }

    function getLimit() {
      return parseInt(limitEl.value) || defaultLimit;
    }

    async function loadFeedback() {
      const params = new URLSearchParams({
        channel: channelEl.value,
        direction: directionEl.value,
        result: resultEl.value.trim(),
        limit: getLimit(),
        offset
      });

      // Remove empty params
      for (let [key, value] of params.entries()) {
        if (!value) params.delete(key);
      }

      try {
        const resp = await fetch(`/api/feedback?${params}`);
        const data = await resp.json();

        feedback = data.items || [];
        renderFeedbackList();
        updatePager(data.count, data.limit, data.offset);
      } catch (e) {
        console.error("Failed to load feedback:", e);
        feedbackListEl.innerHTML = `<div class="text-center py-8 text-red-500">Error loading feedback: ${e.message}</div>`;
      }
    }

    function renderFeedbackList() {
      if (!feedback.length) {
        feedbackListEl.innerHTML = `<div class="text-center py-8 text-slate-500">No feedback found</div>`;
        return;
      }

      feedbackListEl.innerHTML = feedback.map(fb => `
        <div class="rounded-xl border bg-slate-50 p-4">
          <div class="flex items-start justify-between">
            <div>
              <div class="font-medium">${esc(fb.company_name || "—")} (${esc(fb.email_primary || "—")})</div>
              <div class="text-sm text-slate-600 mt-1">${esc(fb.note || "No note")}</div>
            </div>
            <div class="text-right text-xs text-slate-500">
              ${formatDate(fb.created_at)}
              <div class="mt-1">
                <span class="inline-block rounded-full px-2 py-1 text-xs bg-blue-100 text-blue-800">
                  ${esc(fb.channel)} • ${esc(fb.direction)}
                </span>
                <span class="inline-block rounded-full px-2 py-1 text-xs bg-green-100 text-green-800 ml-1">
                  ${esc(fb.result || "—")}
                </span>
              </div>
            </div>
          </div>
        </div>
      `).join("");
    }

    function updatePager(count, limit, currentOffset) {
      const start = currentOffset + 1;
      const end = Math.min(currentOffset + feedback.length, count);
      
      pagerTextEl.textContent = `Results ${start}–${end} of ${count}`;
      prevBtnEl.disabled = currentOffset === 0;
      nextBtnEl.disabled = end >= count;
    }

    function formatDate(dateStr) {
      if (!dateStr) return "—";
      const date = new Date(dateStr);
      return date.toLocaleString();
    }

    function esc(s) {
      return (s + "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
  </script>
</body>
</html>